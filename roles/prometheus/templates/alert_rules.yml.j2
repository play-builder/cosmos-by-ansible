groups:
  - name: cosmos_node_alerts
    rules:
      - alert: NodeDown
        expr: up == 0
        for: {{ alert_node_down_threshold | default('2m') }}
        labels:
          severity: critical
        annotations:
          summary: "Node {{ '{{' }} $labels.instance {{ '}}' }} is down"
          description: "Node {{ '{{' }} $labels.instance {{ '}}' }} ({{ '{{' }} $labels.chain {{ '}}' }}) has been down for more than {{ alert_node_down_threshold | default('2m') }}"
      - alert: HighMissedBlocks
        expr: increase(cometbft_consensus_validator_missed_blocks[1h]) > {{ alert_high_block_miss_threshold | default(100) }}
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High missed blocks on {{ '{{' }} $labels.instance {{ '}}' }}"
          description: "Validator {{ '{{' }} $labels.instance {{ '}}' }} has missed {{ '{{' }} $value {{ '}}' }} blocks in the last hour"
      - alert: NodeNotSyncing
        expr: cometbft_consensus_height - cometbft_consensus_latest_block_height > 10
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Node {{ '{{' }} $labels.instance {{ '}}' }} is not syncing"
          description: "Node {{ '{{' }} $labels.instance {{ '}}' }} is {{ '{{' }} $value {{ '}}' }} blocks behind"
      - alert: LowPeerCount
        expr: cometbft_p2p_peers < 3
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Low peer count on {{ '{{' }} $labels.instance {{ '}}' }}"
          description: "Node {{ '{{' }} $labels.instance {{ '}}' }} has only {{ '{{' }} $value {{ '}}' }} peers"
  - name: system_alerts
    rules:
      - alert: HighCPUUsage
        expr: 100 - (avg by(instance) (rate(node_cpu_seconds_total{mode="idle"}[5m])) * 100) > {{ alert_cpu_usage_threshold | default(90) }}
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High CPU usage on {{ '{{' }} $labels.instance {{ '}}' }}"
          description: "CPU usage is {{ '{{' }} printf \"%.2f\" $value {{ '}}' }}% on {{ '{{' }} $labels.instance {{ '}}' }}"
      - alert: HighMemoryUsage
        expr: (1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) * 100 > {{ alert_memory_usage_threshold | default(90) }}
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High memory usage on {{ '{{' }} $labels.instance {{ '}}' }}"
          description: "Memory usage is {{ '{{' }} printf \"%.2f\" $value {{ '}}' }}% on {{ '{{' }} $labels.instance {{ '}}' }}"
      - alert: HighDiskUsage
        expr: (1 - (node_filesystem_avail_bytes{fstype!="tmpfs"} / node_filesystem_size_bytes{fstype!="tmpfs"})) * 100 > {{ alert_disk_usage_threshold | default(85) }}
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High disk usage on {{ '{{' }} $labels.instance {{ '}}' }}"
          description: "Disk usage is {{ '{{' }} printf \"%.2f\" $value {{ '}}' }}% on {{ '{{' }} $labels.instance {{ '}}' }} ({{ '{{' }} $labels.mountpoint {{ '}}' }})"
      - alert: SystemReboot
        expr: changes(node_boot_time_seconds[10m]) > 0
        labels:
          severity: warning
        annotations:
          summary: "System rebooted on {{ '{{' }} $labels.instance {{ '}}' }}"
          description: "{{ '{{' }} $labels.instance {{ '}}' }} has rebooted"
  - name: validator_alerts
    rules:
      - alert: ValidatorJailed
        expr: cosmos_validator_jailed == 1
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Validator {{ '{{' }} $labels.moniker {{ '}}' }} is jailed"
          description: "Validator {{ '{{' }} $labels.moniker {{ '}}' }} on {{ '{{' }} $labels.chain {{ '}}' }} has been jailed!"
      - alert: ValidatorLowRank
        expr: cosmos_validator_rank > 100
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "Validator {{ '{{' }} $labels.moniker {{ '}}' }} has low rank"
          description: "Validator {{ '{{' }} $labels.moniker {{ '}}' }} is at rank {{ '{{' }} $value {{ '}}' }}"
      - alert: ValidatorNotActive
        expr: cosmos_validator_active == 0
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "Validator {{ '{{' }} $labels.moniker {{ '}}' }} is not active"
          description: "Validator {{ '{{' }} $labels.moniker {{ '}}' }} is not in the active validator set"
