---
- name: Setup Exporters on Validator Nodes
  hosts: validators
  become: yes
  gather_facts: yes
  pre_tasks:
    - name: Load chain variables
      include_vars:
        file: "{{ playbook_dir }}/../chain_vars/{{ chain_name }}.yml"
      when: chain_name is defined
    - name: Display setup information
      debug:
        msg: |
          =====================================
          Setting up Exporters
          =====================================
          Host: {{ inventory_hostname }}
          Chain: {{ chain_name | default('N/A') }}
          Components:
          - Node Exporter (port {{ node_exporter_port }})
          - Cosmos Exporter (port {{ cosmos_exporter_port }})
          =====================================
  tasks:
    - name: Setup Node Exporter
      include_role:
        name: node-exporter
    - name: Setup Cosmos Exporter
      include_role:
        name: cosmos-exporter
      when: chain_name is defined
  post_tasks:
    - name: Verify Node Exporter
      uri:
        url: "http://localhost:{{ node_exporter_port }}/metrics"
        status_code: 200
      register: node_exporter_check
      ignore_errors: yes
    - name: Verify Cosmos Exporter
      uri:
        url: "http://localhost:{{ cosmos_exporter_port }}/metrics"
        status_code: 200
      register: cosmos_exporter_check
      ignore_errors: yes
      when: chain_name is defined
    - name: Display status
      debug:
        msg: |
          =====================================
          Exporter Setup Complete!
          =====================================
          Node Exporter: {{ 'OK' if node_exporter_check.status == 200 else 'FAILED' }}
            URL: http://{{ ansible_host }}:{{ node_exporter_port }}/metrics
          Cosmos Exporter: {{ 'OK' if cosmos_exporter_check.status | default(0) == 200 else 'N/A or FAILED' }}
            URL: http://{{ ansible_host }}:{{ cosmos_exporter_port }}/metrics
          모니터링 서버에서 타겟 추가 확인:
          - Prometheus targets: http://<monitoring-server>:9090/targets
          =====================================
